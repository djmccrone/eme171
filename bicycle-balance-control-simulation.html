<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Bicycle Balance Control Simulation | EME 171: Analysis, Simulation and Design of Mechatronic Systems
</title>
  <link rel="canonical" href="https://moorepants.github.io/eme171/bicycle-balance-control-simulation.html">


  <link rel="stylesheet" href="https://moorepants.github.io/eme171/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://moorepants.github.io/eme171/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://moorepants.github.io/eme171/theme/css/pygments/emacs.min.css">
  <link rel="stylesheet" href="https://moorepants.github.io/eme171/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://moorepants.github.io/eme171/feeds/all.atom.xml">
  
  <meta name="description" content="The model presented here is based on the model described here: https://plot.ly/ipython-notebooks/bicycle-control-design/ eval_bicycle_rhs The file eval_bicycle_rhs.m encodes the 1st order ordinary differential equations that govern the steer-roll dynamics of a bicycle. The steer and steer rate inputs are set to constants. function xdot = eval_bicycle_rhs(t â€¦">
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o);
      a.async = 1;
      a.src = g;
      m = s.getElementsByTagName(o)[0];
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-15966419-8', 'auto');
    ga('send', 'pageview');
  </script>


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="https://moorepants.github.io/eme171/">EME 171: Analysis, Simulation and Design of Mechatronic Systems</a></h1>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/">Syllabus</a></li>
            <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/schedule.html">Schedule</a></li>
            <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/resources.html">Resources</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Bicycle Balance Control Simulation
</h1>
      <hr>

<article class="article">
  <div class="content">
    <p>The model presented here is based on the model described here:</p>
<p><a class="reference external" href="https://plot.ly/ipython-notebooks/bicycle-control-design/">https://plot.ly/ipython-notebooks/bicycle-control-design/</a></p>
<div class="section" id="eval-bicycle-rhs">
<h2>eval_bicycle_rhs</h2>
<p>The file <a class="reference external" href="https://moorepants.github.io/eme171/scripts/eval_bicycle_rhs.m"><tt class="docutils literal">eval_bicycle_rhs.m</tt></a> encodes the 1st order ordinary differential
equations that govern the steer-roll dynamics of a bicycle. The steer and steer
rate inputs are set to constants.</p>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>xdot <span class="p">=</span><span class="w"> </span><span class="nf">eval_bicycle_rhs</span><span class="p">(</span>t, x, r, p<span class="p">)</span><span class="w"></span>

<span class="c">% unpack states</span>
<span class="n">omega</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">theta</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="nb">psi</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="c">% unpack inputs</span>
<span class="nb">beta</span> <span class="p">=</span> <span class="n">r</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c">% steer rate</span>
<span class="n">delta</span> <span class="p">=</span> <span class="n">r</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c">% steer angle</span>

<span class="c">% unpack parameters</span>
<span class="n">m</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
<span class="n">g</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="n">h</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">h</span><span class="p">;</span>
<span class="n">a</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="n">b</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
<span class="n">v</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">v</span><span class="p">;</span>
<span class="n">I</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">I</span><span class="p">;</span>

<span class="c">% calculate the state derivatives</span>
<span class="n">omegadot</span> <span class="p">=</span> <span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">theta</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="nb">beta</span> <span class="o">+</span> <span class="n">v</span>^<span class="mi">2</span><span class="o">*</span><span class="n">delta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">I</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">h</span>^<span class="mi">2</span><span class="p">);</span>
<span class="n">thetadot</span> <span class="p">=</span> <span class="n">omega</span><span class="p">;</span>
<span class="n">psidot</span> <span class="p">=</span> <span class="n">v</span><span class="o">/</span><span class="n">b</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>

<span class="c">% pack up the results</span>
<span class="n">xdot</span> <span class="p">=</span> <span class="p">[</span><span class="n">omegadot</span><span class="p">;</span> <span class="n">thetadot</span><span class="p">;</span> <span class="n">psidot</span><span class="p">];</span><span class="n"></span>

<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="eval-bicycle-rhs2">
<h2>eval_bicycle_rhs2</h2>
<p>The file <a class="reference external" href="https://moorepants.github.io/eme171/scripts/eval_bicycle_rhs2.m"><tt class="docutils literal">eval_bicycle_rhs2.m</tt></a> encodes the 1st order ordinary differential
equations that govern the steer-roll dynamics of a bicycle. The steer and steer
rate inputs are calculated by an input function.</p>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>xdot <span class="p">=</span><span class="w"> </span><span class="nf">eval_bicycle_rhs2</span><span class="p">(</span>t, x, w, p<span class="p">)</span><span class="w"></span>

<span class="c">% unpack states</span>
<span class="n">omega</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">theta</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="nb">psi</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="c">% calculate r with the passed in function w(t, x, p)</span>
<span class="n">r</span> <span class="p">=</span> <span class="n">w</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="c">% unpack inputs</span>
<span class="nb">beta</span> <span class="p">=</span> <span class="n">r</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c">% steer rate</span>
<span class="n">delta</span> <span class="p">=</span> <span class="n">r</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c">% steer angle</span>

<span class="c">% unpack parameters</span>
<span class="n">m</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
<span class="n">g</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="n">h</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">h</span><span class="p">;</span>
<span class="n">a</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="n">b</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
<span class="n">v</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">v</span><span class="p">;</span>
<span class="n">I</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">I</span><span class="p">;</span>

<span class="c">% calculate the state derivatives</span>
<span class="n">omegadot</span> <span class="p">=</span> <span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">theta</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="nb">beta</span> <span class="o">+</span> <span class="n">v</span>^<span class="mi">2</span><span class="o">*</span><span class="n">delta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">I</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">h</span>^<span class="mi">2</span><span class="p">);</span>
<span class="n">thetadot</span> <span class="p">=</span> <span class="n">omega</span><span class="p">;</span>
<span class="n">psidot</span> <span class="p">=</span> <span class="n">v</span><span class="o">/</span><span class="n">b</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>

<span class="c">% pack up the results</span>
<span class="n">xdot</span> <span class="p">=</span> <span class="p">[</span><span class="n">omegadot</span><span class="p">;</span> <span class="n">thetadot</span><span class="p">;</span> <span class="n">psidot</span><span class="p">];</span><span class="n"></span>

<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="eval-steer-control-input-m">
<h2>eval_steer_control_input.m</h2>
<p>The file <a class="reference external" href="https://moorepants.github.io/eme171/scripts/eval_steer_control_input.m"><tt class="docutils literal">eval_steer_control_input.m</tt></a> encodes a PD controller that generates
the steer and steer rate inputs.</p>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>r <span class="p">=</span><span class="w"> </span><span class="nf">eval_steer_control_input</span><span class="p">(</span>t, x, p<span class="p">)</span><span class="w"></span>

<span class="c">% unpack the states</span>
<span class="n">omega</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">theta</span> <span class="p">=</span> <span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c">% unpack the control gains</span>
<span class="n">kp</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">kp</span><span class="p">;</span>

<span class="c">% calculate the inputs</span>
<span class="nb">beta</span> <span class="p">=</span> <span class="n">kp</span><span class="o">*</span><span class="n">omega</span><span class="p">;</span>
<span class="n">delta</span> <span class="p">=</span> <span class="n">kp</span><span class="o">*</span><span class="n">theta</span><span class="p">;</span>

<span class="c">% pack up the inputs</span>
<span class="n">r</span> <span class="p">=</span> <span class="p">[</span><span class="nb">beta</span><span class="p">;</span> <span class="n">delta</span><span class="p">];</span><span class="n"></span>

<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="bicycle-main-m">
<h2>bicycle_main.m</h2>
<p>The file <a class="reference external" href="https://moorepants.github.io/eme171/scripts/bicycle_main.m"><tt class="docutils literal">bicycle_main.m</tt></a> runs the simulation with the constant inputs and the
inputs from the controller.</p>
<div class="highlight"><pre><span></span><span class="c">% this is the simulation we did in class of the bicycle balance model</span>

<span class="c">% Set the initial values of the states (initial conditions).</span>
<span class="c">% Given an initial 5 deg roll angle and 5 deg steer angle, simulate the system.</span>
<span class="n">x0</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span>  <span class="c">% roll rate [rad/s]</span>
      <span class="mi">5</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>  <span class="c">% roll angle [rad]</span>
      <span class="mi">0</span><span class="p">];</span>  <span class="c">% heading angle [rad]</span>

      <span class="c">% Generate time values for a 4 second duration.</span>
<span class="n">ts</span> <span class="p">=</span> <span class="nb">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>  <span class="c">% time values</span>

<span class="c">% Set the inputs to constant values.</span>
<span class="n">r</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span>  <span class="c">% steer rate [rad/s]</span>
     <span class="mi">5</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">];</span>  <span class="c">% steer angle [rad/s]</span>

<span class="c">% Define all of the numerical values for the constant parameters in a structure.</span>
<span class="n">p</span><span class="p">.</span><span class="n">m</span> <span class="p">=</span> <span class="mi">87</span><span class="p">;</span>  <span class="c">% kg</span>
<span class="n">p</span><span class="p">.</span><span class="n">g</span> <span class="p">=</span> <span class="mf">9.81</span><span class="p">;</span>  <span class="c">% m/s^2</span>
<span class="n">p</span><span class="p">.</span><span class="n">h</span> <span class="p">=</span> <span class="mf">1.0</span><span class="p">;</span>  <span class="c">% m</span>
<span class="n">p</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="mf">0.5</span><span class="p">;</span>  <span class="c">% m</span>
<span class="n">p</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="mf">1.0</span><span class="p">;</span>  <span class="c">% m</span>
<span class="n">p</span><span class="p">.</span><span class="n">v</span> <span class="p">=</span> <span class="mf">5.0</span><span class="p">;</span>  <span class="c">% m/s</span>
<span class="n">p</span><span class="p">.</span><span class="n">I</span> <span class="p">=</span> <span class="mf">3.28</span><span class="p">;</span>  <span class="c">% kg m^2</span>

<span class="c">% Setup the anonymous function for ode45.</span>
<span class="n">eval_bicycle_rhs_anon</span> <span class="p">=</span> <span class="p">@(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">eval_bicycle_rhs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="c">% Integrate the ODEs (simulate) with ode45.</span>
<span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="n">xs</span><span class="p">]</span> <span class="p">=</span> <span class="n">ode45</span><span class="p">(</span><span class="n">eval_bicycle_rhs_anon</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">x0</span><span class="p">);</span>

<span class="c">% plot the results</span>
<span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">xs</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="nb">pi</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="s">&#39;\omega [deg/s]&#39;</span><span class="p">,</span> <span class="s">&#39;\theta [deg]&#39;</span><span class="p">,</span> <span class="s">&#39;\psi [deg]&#39;</span><span class="p">)</span>

<span class="c">% this is a second simulation of the same model but it has an input function</span>
<span class="c">% with a controller</span>

<span class="c">% add a parameters for the proportional control input</span>
<span class="n">p</span><span class="p">.</span><span class="n">kp</span> <span class="p">=</span> <span class="mf">2.5</span><span class="p">;</span> <span class="c">% proportional gain</span>

<span class="c">% define a new anonymous function that makes use of the input function</span>
<span class="n">eval_bicycle_rhs_anon2</span> <span class="p">=</span> <span class="c">...</span>
    <span class="p">@(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">eval_bicycle_rhs2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">@</span><span class="n">eval_steer_control_input</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="c">% simulate</span>
<span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="n">xs</span><span class="p">]</span> <span class="p">=</span> <span class="n">ode45</span><span class="p">(</span><span class="n">eval_bicycle_rhs_anon2</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">x0</span><span class="p">);</span>

<span class="c">% plot the state trajectories</span>
<span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">xs</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="nb">pi</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="s">&#39;\omega [deg/s]&#39;</span><span class="p">,</span> <span class="s">&#39;\theta [deg]&#39;</span><span class="p">,</span> <span class="s">&#39;\psi [deg]&#39;</span><span class="p">)</span>

<span class="c">% plot the input trajectories</span>
<span class="n">rs</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span><span class="n"></span>
<span class="n">for </span><span class="s">i = 1:length(ts)</span><span class="p"></span>
    <span class="n">rs</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="p">:)</span> <span class="p">=</span> <span class="n">eval_steer_control_input</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="nb">i</span><span class="p">),</span> <span class="n">xs</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="p">:),</span> <span class="n">p</span><span class="p">);</span><span class="n"></span>
<span class="n">end</span>
<span class="s">figure(3)</span><span class="p"></span>
<span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">rs</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="nb">pi</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">(</span><span class="s">&#39;\beta [deg/s]&#39;</span><span class="p">,</span> <span class="s">&#39;\delta [deg]&#39;</span><span class="p">)</span>
</pre></div>
</div>

  </div>
</article>


    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://moorepants.github.io/eme171/categories.html">Categories</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>
<div class="row">
  <div class="col-sm-4 mx-auto text-center text-muted" >
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
    </a>
    <br />
    This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
  </div>
</div>    </div>
  </footer>
</body>

</html>